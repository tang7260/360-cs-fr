<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png" />
    <link rel="icon" type="image/png" href="../assets/img/favicon.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>360</title>

    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />


    <!-- Bootstrap core CSS     -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

    <link href="assets/css/animate.css" rel="stylesheet" />

    <!--  Material Dashboard CSS    -->
    <link href="assets/css/material-dashboard.css" rel="stylesheet" />

    <link href="assets/css/loading.css" rel="stylesheet" />

    <link href="assets/css/card.css" rel="stylesheet" />

    <!--     Fonts and icons     -->
    <link href="assets/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300|Material+Icons' rel='stylesheet' type='text/css'>

    <link type="text/css" rel="stylesheet" href="assets/css/lightGallery.css" />
    <script src="assets/js/js.cookie.js" type="text/javascript"></script>
    <style>
        li {
            list-style-type: none;
        }
        
        img {
            margin-left: -17px;
        }
        
        hr {
            border: 0;
            height: 1px;
            background: #333;
            background-image: linear-gradient(to right, #cccccc, #aaaaaa, #cccccc);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background-color: #cfd3df;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            background-color: #7e7e7e;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-color="red" data-image="assets/img/sidebar-1.jpg">

            <!--
		        Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"

		        Tip 2: you can also add an image using data-image tag
		    -->

            <div class="logo wow fadeIn">
                <a href="index.html" class="simple-text">
					360
				</a>
            </div>

            <div class="sidebar-wrapper wow fadeIn">
                <ul class="nav">
                    <li>
                        <a href="index.html">
                            <i class="material-icons">linked_camera</i>
                            <p>Raspberry Pi Camera</p>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="material-icons">settings</i>
                            <p>Camera Settings</p>
                        </a>
                    </li>
                    <li class="active">
                        <a href="#">
                            <i class="material-icons">perm_media</i>
                            <p>Media</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-panel">
            <nav class="navbar navbar-transparent navbar-absolute">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#">Camera Media</a>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li>
                                <a href="#pablo" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">dashboard</i>
                                    <p class="hidden-lg hidden-md">Dashboard</p>
                                </a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">notifications</i>
                                    <span class="notification">5</span>
                                    <p class="hidden-lg hidden-md">Notifications</p>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Mike John responded to your email</a></li>
                                    <li><a href="#">You have 5 new tasks</a></li>
                                    <li><a href="#">You're now friend with Andrew</a></li>
                                    <li><a href="#">Another Notification</a></li>
                                    <li><a href="#">Another One</a></li>
                                </ul>
                            </li>
                            <li>
                                <a href="#pablo" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">person</i>
                                    <p class="hidden-lg hidden-md">Profile</p>
                                </a>
                            </li>
                        </ul>

                        <form class="navbar-form navbar-right" role="search">
                            <div class="form-group  is-empty">
                                <input type="text" class="form-control" placeholder="Search">
                                <span class="material-input"></span>
                            </div>
                            <button type="submit" class="btn btn-white btn-round btn-just-icon">
                                <i class="material-icons">search</i>
                                <div class="ripple-container"></div>
                            </button>
                        </form>
                    </div>
                </div>
            </nav>

            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="card card-nav-tabs card-plain">
                            <div class="card-header wow fadeInDown" data-background-color="">
                                <div class="nav-tabs-navigation">
                                    <div class="nav-tabs-wrapper">
                                        <ul class="nav nav-tabs wow fadeInDown">
                                            <li>
                                                <a href="#" id="analysis">
                                                    <i class="material-icons">face</i> Analysis
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" id="select">
                                                    <i class="material-icons">done_all</i> Select
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" id="selectall">
                                                    <i class="material-icons">select_all</i> Select All
                                                    <div class="rip ple-container"></div>
                                                </a>
                                            </li>
                                            <li class="">
                                                <a href="#" id="delete">
                                                    <i class="material-icons">delete</i> Delete Select
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li class="">
                                                <a href="#" id="deleteall">
                                                    <i class="material-icons">delete_forever</i> Delete All
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li class="">
                                                <a href="#" id="download">
                                                    <i class="material-icons">get_app</i> Download
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li class="">
                                                <a href="#" id="getZip">
                                                    <i class="material-icons">archive</i> Get Zip
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="videoDiv">
                            <div style="display:none;" id="demo_video">
                                <video class="lg-video-object lg-html5" controls preload="none">
                                    <source src="media/demo7.mp4" type="video/mp4"> Your browser does not support HTML5 video.
                                </video>
                            </div>
                        </div>

                        <div class="wow fadeInUp">
                            <ul id="lightGallery" class="lightGallery">

                                <li class="col-lg-4 col-md-6 col-sm-12" data-src="media/003_result.jpg">
                                    <div class="div-card card-2 " style="margin-left:-15px; width:99%; background:#f8f8f8;">
                                        <img style="margin-left:0px;" class="img-responsive" src="media/003_result.jpg" />
                                        <div style="margin-left:15px">
                                            <h5 style="font-weight:600;word-wrap: break-word;font-size:15px;">003_result.jpg<label class="pull-right" style="color:#383838;margin-right:10px;"><i class="material-icons" style="font-size:20px;">photo</i></label><br><i class="material-icons" style="font-size:20px;">info_outline</i><label style="color:#383838;font-weight:500;margin-top:-20px;margin-left:10px;"> 1.23 Mb</label><label style="color:#383838;font-weight:500;margin-left:5px;"> </label><br>
                                        <i class="material-icons" style="font-size:20px;">access_time</i><label style="color:#383838;font-weight:500;margin-top:-20px;margin-left:10px;"> 2017-1-16, 23:40:26</label>
                                        </h5>
                                            <div class="g_btn" style="margin-top:-25px;margin-left:0px">
                                                <button class="btn btn-info btn-sm"><i class="material-icons">face</i> analysis</button>
                                                <button style="display:none;" class="btn btn-success btn-sm"><i class="material-icons">done</i> Select</button>
                                                <button style="margin-top:0px;margin-right:3%" class="pull-right btn btn-danger btn-fab btn-fab-mini btn-round"><i class="material-icons">delete</i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                </li>

                                <li class="col-lg-4 col-md-6 col-sm-12" data-poster="media/demo7.mp4_th.jpg" data-sub-html="360 demo video " data-html="#demo_video">
                                    <div class="div-card card-2" style="margin-left:-15px; width:99%; background:#f8f8f8;">
                                        <img style="margin-left:0px;" class="img-responsive " src="media/demo7.mp4_th.jpg" />
                                        <div style="margin-left:15px">
                                            <h5 style="font-weight:600;word-wrap: break-word;font-size:15px;">demo7.mp4<label class="pull-right" style="color:#383838;margin-right:10px;"><i class="material-icons" style="font-size:20px;">videocam</i></label><br><i class="material-icons" style="font-size:20px;">info_outline</i><label style="color:#383838;font-weight:500;margin-top:-20px;margin-left:10px;"> 54 Mb</label><label style="color:#383838;font-weight:500;margin-left:5px;"></label><br>
                                        <i class="material-icons" style="font-size:20px;">access_time</i><label style="color:#383838;font-weight:500;margin-top:-20px;margin-left:10px;"> 2017-01-16, 23:18:17</label>
                                        </h5>
                                            <div class="g_btn" style="margin-top:-25px;margin-left:0px;">
                                                <button id="demo_result" class="btn btn-info btn-sm"><i class="material-icons">face</i> analysis</button>
                                                <button style="display:none;" class="btn btn-success btn-sm"><i class="material-icons">done</i> Select</button>
                                                <button style="margin-top:0px;margin-right:3%" class="pull-right btn btn-danger btn-fab btn-fab-mini btn-round"><i class="material-icons">delete</i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <div class="container-fluid">
                    <nav class="pull-left">
                        <ul>
                            <li>
                                <a href="index.html">
	                                Home
	                            </a>
                            </li>
                        </ul>
                    </nav>
                    <p class="copyright pull-right">
                        &copy;
                        <script>
                            document.write(new Date().getFullYear())
                        </script> <a href="#">360</a> Camera System for surveillance with face recognition
                    </p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Modal Core -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Confirm delete file</h4>
                </div>
                <div class="modal-body">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-simple" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger btn-simple" id="confirm_delete">DELETE</button>
                </div>
            </div>
        </div>
    </div>

</body>

<!--   Core JS Files   -->
<script src="assets/js/jquery-3.1.0.min.js" type="text/javascript"></script>
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/js/material.min.js" type="text/javascript"></script>
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/js/wow.min.js"></script>


<!--  Charts Plugin -->
<script src="assets/js/chartist.min.js"></script>

<!--  Notifications Plugin    -->
<script src="assets/js/bootstrap-notify.js"></script>

<!-- Material Dashboard javascript methods -->
<script src="assets/js/material-dashboard.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>

<script src="assets/js/lightgallery.min.js"></script>

<!-- lightgallery plugins -->
<script src="assets/js/lg-thumbnail.min.js"></script>
<script src="assets/js/lg-fullscreen.min.js"></script>
<script src="assets/js/lg-video.js"></script>
<script src="assets/js/lg-zoom.js"></script>
<script src="assets/js/lg-hash.js"></script>
<script src="assets/js/lg-pager.js"></script>
<script>
    var apiUrl = "";
    var path = "/picam/";
    var fullPath = "";
    var $lg = $('#lightGallery');
    var lgdisplay = false;
    var lgOpen = false;
    var imagesize = [];

    $(document).ready(function () {
        new WOW().init();
        getApiUrl();
        $('#select').click(function () {
            toggleLightGallery();
            $('.g_btn').toggle("slow");
        });
        get_media();
        $('#demo_result').click(function () {
            window.location.href = 'analysis.html';
        })
    });

    function toggleLightGallery() {
        if (lgdisplay) {
            $lg.data('lightGallery').destroy(true);
            lgdisplay = false;
        } else {
            $lg.lightGallery();
            lgdisplay = true;
        }
    }

    var ajax_file;

    if (window.XMLHttpRequest) {
        ajax_file = new XMLHttpRequest();
    } else {
        ajax_file = new ActiveXObject("Microsoft.XMLHTTP");
    }

    function deleteMedia(fileName, displayname) {
        $(".modal-body").html('Are you sure you want to delete '+ displayname +' ?');
        $("#confirm_delete").click(function(){
            $.post(fullPath + "preview.php", {
                delete1: fileName
            });
            location.reload();
        });
        $("#myModal").modal()      
    }
    
    function analysis(id){
        $('#'+id).submit();
        console.log('submit');
    }

    function get_media() {
        $.ajax({
            url: fullPath + "media/get_file.php",
            dataType: 'json',
            success: function (json) {
                imagesize = json["imagesize"];
                var width = 0;
                var height = 0;
                var jsonLength = json["filename"].length;
                for (var i in json["filename"]) {
                    var type = json["filetype"][i] == "video" ? "videocam" : "photo";
                    var liheader = '<li class="col-lg-4 col-md-6 col-sm-12" data-src="' + fullPath + 'get_media.php?type=' + json["filetype"][i] + '&file=' + json["filename"][i] + '">';
                    var videoDiv = '<div style="display:none;" id="video' + i + '">\
                                <video class="lg-video-object lg-html5" controls preload="none">\
                                    <source src="' + fullPath + 'get_media.php?type=' + json["filetype"][i] + '&file=' + json["filename"][i] + '" type="video/mp4"> Your browser does not support HTML5 video.\
                                </video>\
                            </div>';
                    if (type == "videocam") {
                        liheader = '<li class="col-lg-4 col-md-6 col-sm-12" data-poster="' + fullPath + 'get_media.php?type=' + json["filetype"][i] + '&file=' + json["thimg"][i] + '" data-sub-html="' + json["filename"][i] + '" data-html="#video' + i + '">';
                        $(videoDiv).appendTo($('#videoDiv'));
                        
                    }else{
                        width = json["imagesize"][i]["0"];
                        height = json["imagesize"][i]["1"];
                        console.log('w',json["filetime"][i]);
                    }
                    var li = liheader +
                        '<div class="div-card card-2" style="margin-left:-15px; width:99%; background:#f8f8f8;">\
                                    <img style="margin-left:0px;" class=" img-responsive " src="' + fullPath + 'get_media.php?type=' + json["filetype"][i] + '&file=' + json["thimg"][i] + '" />\
                                    <div style="margin-left:15px">\
                                        <h5 style="font-weight:600;word-wrap: break-word;font-size:15px;">' + json["filename"][i] + '<label class="pull-right" style="color:#383838;margin-right:10px;"><i class="material-icons" style="font-size:20px;">' + type + '</i></label><br><i class="material-icons" style="font-size:20px;">info_outline</i><label style="color:#383838;font-weight:500;margin-top:-20px;margin-left:10px;">' + json["filesize"][i] + '</label><label style="color:#383838;font-weight:500;margin-left:5px;"></label><br>\
                                        <i class="material-icons" style="font-size:20px;">access_time</i><label style="color:#383838;font-weight:500;margin-top:-20px;margin-left:10px;">' + json["filetime"][i] + '</label>\
                                        </h5>\
                                        <div class="g_btn" style="margin-top:-25px;margin-left:0px;">\
                                            <form method="post" id="ana'+ i +'"\ action="analysis.php">\
                                            <button class="btn btn-info btn-sm"><i class="material-icons" >face</i> analysis</button>\
                                            <button style="display:none;" class="btn btn-success btn-sm"><i class="material-icons">done</i> Select</button>\
                                            <input type="hidden" name="filename" value="' + json["filename"][i] + '">\
                                            <input type="hidden" name="datetime" value="' + json["filetime"][i] + '">\
                                            <input type="hidden" name="filesize" value="' + json["filesize"][i] + '">\
                                            <input type="hidden" name="width" value="' + width + '">\
                                            <input type="hidden" name="height" value="' + height + '">\
                                            <input type="hidden" name="file_url" value="' + fullPath + 'get_media.php?type=' + json["filetype"][i] + '&file=' + json["thimg"][i] + '">\
                                            </form>\
                                            <button style="margin-top:-50px;margin-right:3%" class="pull-right btn btn-danger btn-fab btn-fab-mini btn-round" onclick="deleteMedia(\'' + json["thimg"][i] + '\',\'' + json["filename"][i] + '\')"><i class="material-icons">delete</i></button>\
                                        </div>\
                                    </div>\
                                 </div>\
                              <br>\
                            </li>';
                    //                    $(li).appendTo($('.lightGallery'));
                    $lg.append(li);
                }
                console.log("length", jsonLength);
                //toggleLightGallery();
                $('img').hover(
                    function () {
                        toggleLightGallery();
                    },
                    function () {
                        if (!lgOpen) {
                            $lg.data('lightGallery').destroy(true);
                            lgdisplay = false;
                        }
                    }
                );
                $lg.on('onBeforeOpen.lg', function (event, index, fromTouch, fromThumb) {
                    lgOpen = true;
                    lgdisplay = true;
                });
                $lg.on('onCloseAfter.lg', function (event) {
                    lgOpen = false;
                    $lg.data('lightGallery').destroy(true);
                    lgdisplay = false;
                });
            },
            error: function (data) {

            }
        });
    }

    function getApiUrl() {
        apiUrl = Cookies.get('apiUrl');
        if (apiUrl == "" || apiUrl == null || apiUrl == "undefined") {
            Cookies.set('apiUrl', 'raspberrypi.local/picam', {
                expires: 30
            });
        } else {
            Cookies.set('apiUrl', apiUrl, {
                expires: 30
            });
        }
        apiUrl = Cookies.get('apiUrl');
        if (apiUrl.includes("http://")) {
            fullPath = apiUrl;
        } else {
            fullPath = "http://" + apiUrl;
        }
        if (fullPath.slice(-1) != "/") {
            fullPath = fullPath + "/";
        }
        console.log("Api url: " + apiUrl);
        console.log("Full url: " + fullPath);
    }

    function get_zip_progress(zipname) {
        var ajax_zip;
        if (window.XMLHttpRequest) {
            ajax_zip = new XMLHttpRequest();
        } else {
            ajax_zip = new ActiveXObject("Microsoft.XMLHTTP");
        }

        ajax_zip.onreadystatechange = function () {
            if (ajax_zip.readyState == 4 && ajax_zip.status == 200) {
                if (process_zip_progress(ajax_zip.responseText)) {
                    setTimeout(function () {
                        get_zip_progress(zipname);
                    }, 1000);
                } else {
                    document.getElementById("zipdownload").value = zipname;
                    document.getElementById("zipform").submit();
                    document.getElementById("progress").style.display = "none";
                }
            }
        }
        ajax_zip.open("GET", "preview.php?zipprogress=" + zipname);
        ajax_zip.send();
    }

    function process_zip_progress(str) {
        var arr = str.split("/");
        if (str.indexOf("Done") != -1) {
            return false;
        }
        if (arr.length == 2) {
            var count = parseInt(arr[0]);
            var total = parseInt(arr[1]);
            var progress = document.getElementById("progress");
            var caption = " ";
            if (count > 0) caption = str;
            progress.innerHTML = caption + "<div style=\"width:" + (count / total) * 100 + "%;background-color:#0f0;\">&nbsp;</div>";

        }
        return true;
    }
</script>

</html>