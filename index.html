<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png" />
    <link rel="icon" type="image/png" href="../assets/img/favicon.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>360</title>

    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />


    <!-- Bootstrap core CSS     -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

    <!--  Material Dashboard CSS    -->
    <link href="assets/css/material-dashboard.css" rel="stylesheet" />
    <link href="assets/css/animate.css" rel="stylesheet" />

    <link href="assets/css/loading.css" rel="stylesheet" />
    <!--     Fonts and icons     -->
   <link href="assets/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300|Material+Icons' rel='stylesheet' type='text/css'>
    <link href="assets/css/demo.css" rel="stylesheet" />
    <script src="assets/js/js.cookie.js" type="text/javascript"></script>
</head>

<body onload="setTimeout('init();', 100);">
    <div class="wrapper">
        <div class="sidebar" data-color="orange" data-image="assets/img/sidebar-1.jpg">

            <!--
		        Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"

		        Tip 2: you can also add an image using data-image tag
		    -->

            <div class="logo">
                <a href="index.html" class="simple-text">
					360
				</a>
            </div>

            <div class="sidebar-wrapper">
                <ul class="nav">
                    <li class="active">
                        <a href="index.html">
                            <i class="material-icons">linked_camera</i>
                            <p>Raspberry Pi Camera</p>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="material-icons">settings</i>
                            <p>Camera Settings</p>
                        </a>
                    </li>
                    <li>
                        <a href="media.html">
                            <i class="material-icons">perm_media</i>
                            <p>Media</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-panel">
            <nav class="navbar navbar-transparent navbar-absolute">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#">Raspberry Pi Camera</a>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li>
                                <a href="#pablo" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">dashboard</i>
                                    <p class="hidden-lg hidden-md">Dashboard</p>
                                </a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">notifications</i>
                                    <span class="notification">5</span>
                                    <p class="hidden-lg hidden-md">Notifications</p>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Mike John responded to your email</a></li>
                                    <li><a href="#">You have 5 new tasks</a></li>
                                    <li><a href="#">You're now friend with Andrew</a></li>
                                    <li><a href="#">Another Notification</a></li>
                                    <li><a href="#">Another One</a></li>
                                </ul>
                            </li>
                            <li>
                                <a href="#pablo" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="material-icons">person</i>
                                    <p class="hidden-lg hidden-md">Profile</p>
                                </a>
                            </li>
                        </ul>

                        <form class="navbar-form navbar-right" role="search">
                            <div class="form-group  is-empty">
                                <input type="text" class="form-control" placeholder="Search">
                                <span class="material-input"></span>
                            </div>
                            <button type="submit" class="btn btn-white btn-round btn-just-icon">
                                <i class="material-icons">search</i>
                                <div class="ripple-container"></div>
                            </button>
                        </form>
                    </div>
                </div>
            </nav>

            <div class="content wow fadeInDown">
                <div class="container-fluid">
                    <div class="row ">
                        <div class="card card-nav-tabs">
                            <div id="taskHeader" class="card-header wow fadeInDown" data-background-color="blue">
                                <div class="nav-tabs-navigation">
                                    <div class="nav-tabs-wrapper">
                                        <span class="nav-tabs-title"></span>
                                        <ul class="nav nav-tabs wow fadeInDown" data-tabs="tabs">
                                            <li class="active">
                                                <a href="#profile" data-toggle="tab">
                                                    <i class="material-icons">personal_video</i> Live preview
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li class="" id="face_btn">
                                                <a href="#messages" data-toggle="tab">
                                                    <i class="material-icons">face</i> Face
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li class="">
                                                <a href="#settings" data-toggle="tab">
                                                    <i class="material-icons">settings_power</i> System
                                                    <div class="ripple-container"></div>
                                                </a>
                                            </li>
                                            <li class="">
                                                <a id="cam" href="#">
                                                </a>
                                            </li>
                                            <li class="">
                                                <a id="cap" href="#">
                                                </a>
                                            </li>
                                            <li class="">
                                                <a id="video" href="#">
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="card-content">
                                <div class="tab-content">
                                    <div class="tab-pane active" id="profile">
                                        <div class="row">
                                            <div id="loader" class="loader"></div>
                                            <div id="error" class="alert alert-danger col-sm-10 col-sm-offset-1">
                                                <div class="container-fluid">
                                                    <div class="alert-icon">
                                                        <i class="material-icons">error_outline</i>
                                                        <b>Error Alert:</b> The raspberry pi camera not initialize.
                                                        <button onclick="init()" class="btn btn-simple" style="color:white;">Try again</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="livepreview" class="col-sm-10 col-sm-offset-1">
                                                <img id="mjpg" alt="Live review" class="img-rounded img-responsive img-raised">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane" id="messages">
                                        <div class="row">
<!--
                                            <div id="loader" class="loader"></div>
                                            <div id="error" class="alert alert-danger col-sm-10 col-sm-offset-1">
                                                <div class="container-fluid">
                                                    <div class="alert-icon">
                                                        <i class="material-icons">error_outline</i>
                                                        <b>Error Alert:</b> The raspberry pi camera not initialize.
                                                        <button onclick="init()" class="btn btn-simple" style="color:white;">Try again</button>
                                                    </div>
                                                </div>
                                            </div>
-->
                                            <div id="livepreviewface" class="col-sm-10 col-sm-offset-1">
                                                <img id="mjpg_face" alt="Live review face" class="img-rounded img-responsive img-raised">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane" id="settings">
                                        <div class="col-sm-12">
                                            <div class="col-sm-12">
                                                <h4>Camera API Settings</h4>
                                            </div>
                                            <div class="col-sm-6">
                                                <div id="api" class="form-group label-floating">
                                                    <input placeholder="API URL" id="apiUrl" value="url" type="text" class="form-control" spellcheck="false">
                                                    <div id="apiIcon"></div>
                                                    <button id="defaultApiBtn" class="btn btn-default pull-right">Default</button>
                                                    <button id="changeApiBtn" class="btn btn-success pull-right">Change</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="sysControl" class="col-sm-12">
                                            <div class="col-sm-8">
                                                <h4>System Control Settings</h4>
                                                <button id="shutdown" class="btn btn-danger pull-left">Shutdown</button>
                                                <button id="reboot" class="btn btn-danger">Reboot</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer">
                <div class="container-fluid">
                    <nav class="pull-left">
                        <ul>
                            <li>
                                <a href="index.html">
	                                Home
	                            </a>
                            </li>
                        </ul>
                    </nav>
                    <p class="copyright pull-right">
                        &copy;
                        <script>
                            document.write(new Date().getFullYear())
                        </script> <a href="#">360</a> Camera System for surveillance with face recognition
                    </p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Modal Core -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                </div>
                <div class="modal-body">
                    Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts. Separated they live in Bookmarksgrove right at the coast of the Semantics, a large language ocean. A small river named Duden flows by their place and supplies it with the necessary regelialia. It is a paradisematic country, in which roasted parts of sentences fly into your mouth. Even the all-powerful Pointing has no control about the blind texts it is an almost unorthographic life One day however a small line of blind text by the name of Lorem Ipsum decided to leave for the far World of Grammar.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-simple" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info btn-simple">Save</button>
                </div>
            </div>
        </div>
    </div>
</body>

<!--   Core JS Files   -->
<script src="assets/js/jquery-3.1.0.min.js" type="text/javascript"></script>
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/js/material.min.js" type="text/javascript"></script>
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/js/wow.min.js"></script>
<!--  Charts Plugin -->
<script src="assets/js/chartist.min.js"></script>

<!--  Notifications Plugin    -->
<script src="assets/js/bootstrap-notify.js"></script>

<!-- Material Dashboard javascript methods -->
<script src="assets/js/material-dashboard.js"></script>
<script src="assets/js/demo.js"></script>
<script>
    var status = "";
    var apiUrl = "";
    var path = "/picam/";
    var fullPath = "";
    $(document).ready(function () {
        $('#livepreview').hide();
        $('#error').hide();
        $('#shutdown').click(function () {
            sys_shutdown();
            demo.showAlert('top', 'center', 'success', 'The raspberry pi has been turned off', 'notifications', 100);
        });
        $('#reboot').click(function () {
            sys_reboot();
            demo.showAlert('top', 'center', 'warning', 'The raspberry pi is restarting', 'notifications', 100);
        });
        $('#cam').click(function () {
            if (status == "ready") {
                send_cmd("ru 0");
                demo.showAlert('top', 'center', 'warning', 'The camera has been paused', 'notifications', 10);
            } else if (status == "video") {
                return;
            } else if (status == "image") {
                return;
            } else if (status == "halted") {
                send_cmd("ru 1");
                demo.showAlert('top', 'center', 'info', 'The camera is enabled', 'notifications', 10);
            } else {
                return;
            }
        });
        $('#cap').click(function () {
            if (status == "ready") {
                send_cmd("im");
                demo.showAlert('top', 'center', 'success', 'The photo has been captured', 'notifications', 10);
            } else if (status == "video") {
                send_cmd("im");
                demo.showAlert('top', 'center', 'success', 'The photo has been captured', 'notifications', 10);
            } else if (status == "image") {
                return;
            } else if (status == "halted") {
                return;
            } else {
                return;
            }
        });
        $('#video').click(function () {
            if (status == "ready") {
                send_cmd("ca 1");
            } else if (status == "video") {
                send_cmd("ca 0");
                demo.showAlert('top', 'center', 'warning', 'Saving to MP4 format ...', 'hourglass_empty', 1000);
            } else if (status == "image") {
                return;
            } else if (status == "halted") {
                return;
            } else {
                return;
            }
        });
        $('#changeApiBtn').click(function () {
            var url = $('#apiUrl').val();
            $('#sysControl').hide(500);
            changeApiUrl(url);
            demo.showAlert('top', 'center', 'success', 'The Camera API URL has been changed', 'notifications', 100);
        });
        $('#defaultApiBtn').click(function () {
            $('#sysControl').hide(500);
            changeApiUrl("raspberrypi.local/picam");
            demo.showAlert('top', 'center', 'success', 'The Camera API has been reverted to the default API', 'notifications', 100);
        });
        $('#face_btn').click(function(){
            live_face();
        });
    });
    //
    // Ajax Commands
    //
    var ajax_cmd;

    if (window.XMLHttpRequest) {
        ajax_cmd = new XMLHttpRequest();
    } else {
        ajax_cmd = new ActiveXObject("Microsoft.XMLHTTP");
    }

    function send_cmd(cmd) {
        ajax_cmd.open("GET", fullPath + "cmd_pipe.php?cmd=" + cmd, true);
        ajax_cmd.send();
    }

    function update_preview_delay() {
        var video_fps = parseInt(document.getElementById("video_fps").value);
        var divider = parseInt(document.getElementById("divider").value);
        preview_delay = Math.floor(divider / Math.max(video_fps, 1) * 1000000);
    }

    //
    // Shutdown
    //
    function sys_shutdown() {
        ajax_cmd.open("GET", fullPath + "cmd_func.php?cmd=shutdown", true);
        ajax_cmd.send();
    }

    function sys_reboot() {
        ajax_cmd.open("GET", fullPath + "cmd_func.php?cmd=reboot", true);
        ajax_cmd.send();
    }

    function reload_ajax(last) {
        $.ajax({
            url: fullPath + "status.php?last=" + last,
            dataType: 'json',
            success: function (json) {
                status = json["status"];
                if ($('#test').hasClass('has-error')) {
                    $('#api').removeClass("has-error").addClass("has-success");
                    $('#apiIcon').html('<span class="form-control-feedback"><i class="material-icons">done</i></span>');
                }
                readyStateChange();
                setTimeout(reload_ajax(status), 5000);
            },
            error: function (data) {
                status = "fail";
                $('#api').removeClass("has-success").addClass("has-error");
                $('#apiIcon').html('<span class="material-icons form-control-feedback">clear</span>');
                $('#livepreview').hide(1000);
                $('#taskHeader').attr("data-background-color", "purple").fadeIn();
                $('#cam').hide(500);
                $('#cap').hide(500);
                $('#video').hide(500);
                $('#sysControl').hide(500);
                demo.showAlert('top', 'center', 'danger', 'The camera has been disconnected', 'error', 100);
                $('#error').fadeOut(1000).fadeIn(1000);
            }
        });
    }

    function readyStateChange() {
        if (status == "ready") {
            $('#cam').html('<i class="material-icons">stop</i> Stop camera');
            $('#cap').html('<i class="material-icons">photo_camera</i> capture').fadeIn("fast");
            $('#video').html('<i class="material-icons">videocam</i> Record video');
            $('#taskHeader').attr("data-background-color", "blue").fadeIn();
            $('#cam').show(500);
            $('#cap').show(500);
            $('#video').show(500);
            $('#sysControl').show(500);
        } else if (status == "video") {
            $('#cam').html('<i class="material-icons">stop</i> Stop camera');
            $('#cap').html('<i class="material-icons">photo_camera</i> capture').fadeIn("fast");
            $('#video').html('<i class="material-icons">videocam_off</i> Stop Record');
            $('#taskHeader').attr("data-background-color", "red").fadeIn();
            $('#cam').hide(500);
            $('#cap').show(500);
            $('#video').show(500);
            $('#sysControl').show(500);
        } else if (status == "image") {
            $('#cam').html('<i class="material-icons">stop</i> Stop camera');
            $('#cap').fadeOut("fast").html('<i class="material-icons">camera_enhance</i> capturing').fadeIn("fast");
            $('#video').html('<i class="material-icons">videocam</i> Record video');
            $('#taskHeader').attr("data-background-color", "green").fadeIn();
            $('#cam').show(500);
            $('#cap').show(500);
            $('#video').show(500);
            $('#sysControl').show(500);
        } else if (status == "halted") {
            $('#cam').html('<i class="material-icons">play_arrow</i> Start camera');
            $('#cap').html('<i class="material-icons">photo_camera</i> capture');
            $('#video').html('<i class="material-icons">videocam</i> Record video');
            $('#taskHeader').attr("data-background-color", "orange").fadeIn();
            $('#cam').show(500);
            $('#cap').hide(500);
            $('#video').hide(500);
            $('#sysControl').show(500);
        } else {
            $('#taskHeader').attr("data-background-color", "purple").fadeIn();
            $('#cam').hide(500);
            $('#cap').hide(500);
            $('#video').hide(500);
            $('#sysControl').hide(500);
        }
    }

    function initcam() {
        $.ajax({
            url: fullPath + "status.php",
            dataType: 'json',
            success: function (json) {
                status = json["status"];
                console.log("Camera Status: " + json["status"]);
                $('#api').removeClass("has-error").addClass("has-success");
                $('#apiIcon').html('<span class="form-control-feedback"><i class="material-icons">done</i></span>');
                $('#mjpg').attr("src", fullPath + "cam_pic_new.php?time=" + new Date().getTime() + "&pDelay=20000");
                $('#loader').hide(500);
                $('#error').hide(500);
                $('#livepreview').fadeOut(1000).fadeIn(1000);
                readyStateChange();
                reload_ajax(status);
            },
            error: function (data) {
                status = "fail";
                console.log("Camera Status: " + status);
                $('#api').removeClass("has-success").addClass("has-error");
                $('#apiIcon').html('<span class="material-icons form-control-feedback">clear</span>');
                $('#loader').hide(1000);
                $('#taskHeader').attr("data-background-color", "purple").fadeIn();
                $('#cam').hide(500);
                $('#cap').hide(500);
                $('#video').hide(500);
                $('#sysControl').hide(500);
                $('#error').fadeOut(1000).fadeIn(1000);
            }
        });
    }

    function init() {
        $('#loader').show(1000);
        $('#error').hide(1000);
        $('#cam').hide(500);
        $('#cap').hide(500);
        $('#video').hide(500);
        $('#sysControl').hide(500);
        getApiUrl();
        $('#apiUrl').val(apiUrl);
        initcam();
    }
    
    function live_face(){
        $('#mjpg_face').attr("src", "http://localhost:5000/video_feed");
    }
    
    function off_face(){
        $('#mjpg_face').attr("src", "");
    }

    function changeApiUrl(url) {
        Cookies.set('apiUrl', url, {
            expires: 30
        });
        getApiUrl();
        $('#apiUrl').val(apiUrl);
    }

    function getApiUrl() {
        apiUrl = Cookies.get('apiUrl');
        if (apiUrl == "" || apiUrl == null || apiUrl == "undefined") {
            Cookies.set('apiUrl', 'raspberrypi.local/picam', {
                expires: 30
            });
        } else {
            Cookies.set('apiUrl', apiUrl, {
                expires: 30
            });
        }
        apiUrl = Cookies.get('apiUrl');
        if (apiUrl.includes("http://")) {
            fullPath = apiUrl ;
        } else {
            fullPath = "http://" + apiUrl ;
        }
        if(fullPath.slice(-1)!="/"){
            fullPath = fullPath + "/";
        }
        console.log("Api url: " + apiUrl);
        console.log("Full url: " + fullPath);
        if(status == "fail")
            initcam();
    }
</script>
<script>
    new WOW().init();
</script>

</html>